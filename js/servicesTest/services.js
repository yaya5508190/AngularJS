/**
 * Created by Alucard on 2014/9/22.
 */
angular.module("finance1", []).factory("convert", ["$http",function ($http) {
    var currencies = [
        "AFN",
        "ALL",
        "DZD",
        "AOA",
        "ARS",
        "AMD",
        "AWG",
        "AUD",
        "AZN",
        "BSD",
        "BHD",
        "BDT",
        "BBD",
        "BYR",
        "BZD",
        "BMD",
        "BTN",
        "BOB",
        "BAM",
        "BWP",
        "BRL",
        "GBP",
        "BND",
        "BGN",
        "BIF",
        "XOF",
        "XAF",
        "XPF",
        "KHR",
        "CAD",
        "CVE",
        "KYD",
        "CLP",
        "CNY",
        "COP",
        "KMF",
        "CDF",
        "CRC",
        "HRK",
        "CUC",
        "CUP",
        "CYP",
        "CZK",
        "DKK",
        "DJF",
        "DOP",
        "XCD",
        "EGP",
        "SVC",
        "EEK",
        "ETB",
        "EUR",
        "FKP",
        "FJD",
        "GMD",
        "GEL",
        "GHS",
        "GIP",
        "XAU",
        "GTQ",
        "GNF",
        "GYD",
        "HTG",
        "HNL",
        "HKD",
        "HUF",
        "ISK",
        "INR",
        "IDR",
        "IRR",
        "IQD",
        "ILS",
        "JMD",
        "JPY",
        "JOD",
        "KZT",
        "KES",
        "KWD",
        "KGS",
        "LAK",
        "LVL",
        "LBP",
        "LSL",
        "LRD",
        "LYD",
        "LTL",
        "MOP",
        "MKD",
        "MGA",
        "MWK",
        "MYR",
        "MVR",
        "MTL",
        "MRO",
        "MUR",
        "MXN",
        "MDL",
        "MNT",
        "MAD",
        "MZN",
        "MMK",
        "ANG",
        "NAD",
        "NPR",
        "NZD",
        "NIO",
        "NGN",
        "KPW",
        "NOK",
        "OMR",
        "PKR",
        "PAB",
        "PGK",
        "PYG",
        "PEN",
        "PHP",
        "PLN",
        "QAR",
        "RON",
        "RUB",
        "RWF",
        "WST",
        "STD",
        "SAR",
        "RSD",
        "SCR",
        "SLL",
        "XAG",
        "SGD",
        "SKK",
        "SIT",
        "SBD",
        "SOS",
        "ZAR",
        "KRW",
        "LKR",
        "SHP",
        "SDG",
        "SRD",
        "SZL",
        "SEK",
        "CHF",
        "SYP",
        "TWD",
        "TZS",
        "THB",
        "TOP",
        "TTD",
        "TND",
        "TRY",
        "TMM",
        "USD",
        "UGX",
        "UAH",
        "UYU",
        "AED",
        "VUV",
        "VEB",
        "VND",
        "YER",
        "ZMK",
        "ZWD"
    ];
    var currenciesMap = {
        AFN:"阿富汗尼",
        ALL:"阿尔巴尼亚列克",
        DZD:"阿尔及利亚第纳尔",
        AOA:"安哥拉宽扎",
        ARS:"阿根廷比索",
        AMD:"亚美尼亚德拉姆",
        AWG:"阿鲁巴弗罗林",
        AUD:"澳大利亚元",
        AZN:"阿塞拜疆马纳特",
        BSD:"巴哈马元",
        BHD:"巴林第纳尔",
        BDT:"孟加拉塔卡",
        BBD:"巴巴多斯元",
        BYR:"白俄罗斯卢布",
        BZD:"伯利兹元",
        BMD:"百慕大元",
        BTN:"不丹努尔特鲁姆",
        BOB:"玻利维亚币",
        BAM:"波斯尼亚马克",
        BWP:"博茨瓦纳普拉",
        BRL:"巴西里尔",
        GBP:"英镑",
        BND:"文莱元",
        BGN:"保加利亚列弗",
        BIF:"布隆迪法郎",
        XOF:"多哥非洲共同体法郎",
        XAF:"刚果中非共同体法郎",
        XPF:"太平洋法兰西共同体法郎F",
        KHR:"柬埔寨瑞尔",
        CAD:"加拿大元",
        CVE:"埃斯库多",
        KYD:"开曼群岛元",
        CLP:"智利比索",
        CNY:"人民币",
        COP:"哥伦比亚比索",
        KMF:"科摩罗法郎",
        CDF:"刚果法郎",
        CRC:"哥斯达黎加科朗",
        HRK:"克罗地亚库纳",
        CUC:"古巴可兑换比索",
        CUP:"古巴比索",
        CYP:"塞浦路斯镑",
        CZK:"捷克克朗",
        DKK:"丹麦克朗",
        DJF:"吉布提法郎",
        DOP:"多米尼加比索",
        XCD:"东加勒比元",
        EGP:"埃及镑",
        SVC:"萨尔瓦多科朗",
        EEK:"爱沙尼亚伦尼",
        ETB:"埃塞俄比亚比尔",
        EUR:"欧元",
        FKP:"福克兰群岛镑",
        FJD:"斐济元",
        GMD:"冈比亚达拉西",
        GEL:"格鲁吉亚拉里",
        GHS:"加纳新赛地",
        GIP:"直布罗陀镑",
        XAU:"黄金(盎司)",
        GTQ:"危地马拉查尔",
        GNF:"几内亚法郎",
        GYD:"圭亚那元",
        HTG:"海地古德",
        HNL:"洪都拉斯皮拉",
        HKD:"港币",
        HUF:"匈牙利福林",
        ISK:"冰岛克朗",
        INR:"印度卢比",
        IDR:"印度尼西亚卢比",
        IRR:"伊朗里亚尔",
        IQD:"伊拉克第纳尔",
        ILS:"以色列新谢克尔",
        JMD:"牙买加元",
        JPY:"日元",
        JOD:"约旦第纳尔",
        KZT:"哈萨克斯坦腾格",
        KES:"肯尼亚先令",
        KWD:"科威特第纳尔",
        KGS:"吉尔吉斯斯坦索姆",
        LAK:"老挝基普",
        LVL:"拉脱维亚拉特",
        LBP:"黎巴嫩镑",
        LSL:"莱索托洛蒂",
        LRD:"利比里亚元",
        LYD:"利比亚第纳尔",
        LTL:"立陶宛立特",
        MOP:"澳门元",
        MKD:"马其顿第纳尔",
        MGA:"马达加斯加阿里亚里",
        MWK:"马拉维克瓦查",
        MYR:"马来西亚林吉特",
        MVR:"马尔代夫拉菲亚",
        MTL:"马耳他镑",
        MRO:"毛里塔尼亚乌吉亚",
        MUR:"毛里求斯卢比",
        MXN:"墨西哥比索",
        MDL:"摩尔多瓦列伊",
        MNT:"蒙古图格里克",
        MAD:"摩洛哥迪拉姆",
        MZN:"莫桑比克美提卡",
        MMK:"缅甸元",
        ANG:"荷属安的列斯盾",
        NAD:"纳米比亚元",
        NPR:"尼泊尔卢比",
        NZD:"新西兰元",
        NIO:"尼加拉瓜科多巴",
        NGN:"尼日利亚奈拉",
        KPW:"南韩元",
        NOK:"挪威克朗",
        OMR:"阿曼里亚尔",
        PKR:"巴基斯坦卢比",
        PAB:"巴拿马巴波亚",
        PGK:"巴布亚新几内亚基那",
        PYG:"巴拉圭瓜尼",
        PEN:"秘鲁新索尔",
        PHP:"菲律宾比索",
        PLN:"波兰兹罗提",
        QAR:"卡塔尔里亚尔",
        RON:"罗马尼亚塑胶币",
        RUB:"俄罗斯卢布",
        RWF:"卢旺达法郎",
        WST:"萨摩亚塔拉",
        STD:"圣多美/普林西比",
        SAR:"沙特里亚尔",
        RSD:"塞尔维亚第纳尔",
        SCR:"塞舌尔卢比",
        SLL:"塞拉利昂利昂",
        XAG:"白银（盎司）",
        SGD:"新加坡元",
        SKK:"斯洛伐克克朗",
        SIT:"斯洛文尼亚拉捷夫",
        SBD:"所罗门群岛元",
        SOS:"索马里先令",
        ZAR:"南非兰特",
        KRW:"北韩元",
        LKR:"斯里兰卡卢比",
        SHP:"圣赫勒拿群岛镑",
        SDG:"苏丹第纳尔",
        SRD:"苏里南元",
        SZL:"斯威士兰里兰吉尼",
        SEK:"瑞典克朗",
        CHF:"瑞士法郎",
        SYP:"叙利亚镑",
        TWD:"台币",
        TZS:"坦桑尼亚先令",
        THB:"泰铢",
        TOP:"汤加潘加",
        TTD:"特立尼达/多巴哥元",
        TND:"突尼斯第纳尔",
        TRY:"突尼斯新里拉",
        TMM:"土库曼斯坦纳特",
        USD:"美元",
        UGX:"乌干达先令",
        UAH:"乌克兰赫夫米",
        UYU:"乌拉圭比索",
        AED:"阿联酋迪拉姆",
        VUV:"瓦努阿图瓦图",
        VEB:"委内瑞拉博利瓦",
        VND:"越南盾",
        YER:"也门里亚尔",
        ZMK:"赞比亚克瓦查",
        ZWD:"津巴布韦元"
    };
    var usdToForeignRates = {};
    var convertCurrency = function(amount, inCurr, outCurr) {
        return amount * usdToForeignRates[outCurr] / usdToForeignRates[inCurr];
    };

    var refresh = function(){
        var YAHOO_FINANCE_URL_PATTERN =
            '//query.yahooapis.com/v1/public/yql?q=select * from '+
            'yahoo.finance.xchange where pair in ("PAIRS")&format=json&'+
            'env=store://datatables.org/alltableswithkeys&callback=JSON_CALLBACK';
        var url = YAHOO_FINANCE_URL_PATTERN.
            replace('PAIRS', 'USD' + currencies.join('","USD'));
        $http.jsonp(url).success(function(data){
            usdToForeignRates = {};
            angular.forEach(data.query.results.rate,function(rate){
                usdToForeignRates[rate.id.substr(3,6)]=parseFloat(rate.Rate);
                //console.dir(usdToForeignRates);
            })
        })
    };

    refresh();
    return {
        convertCurrency : convertCurrency,
        currencies : currencies,
        refresh : refresh,
        currenciesMap : currenciesMap
    }
}])